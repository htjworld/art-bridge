FROM node:22-alpine AS builder
WORKDIR /app

# package 파일과 tsconfig 복사
COPY package*.json ./
COPY tsconfig.json ./

# 루트의 모든 TypeScript 파일 복사
COPY *.ts ./

# 의존성 설치 및 빌드
RUN --mount=type=cache,target=/root/.npm npm install
RUN npm run build

# 빌드 결과 확인
RUN ls -la && ls -la dist/

FROM node:22-alpine AS release
WORKDIR /app

# 빌드된 파일 복사
COPY --from=builder /app/dist/ ./dist/
COPY --from=builder /app/package.json ./
COPY --from=builder /app/package-lock.json ./

ENV NODE_ENV=production
RUN npm ci --omit=dev

# 실행 (플래그 제거)
ENTRYPOINT ["node", "dist/index.js"]
